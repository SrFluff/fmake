#!/bin/python3

version = "1.4.0"

import sys
import os

sys.argv.pop(0)

helps = ["help","--help","-?","-h"]
versions = ["-v","--version","version"]

cc = "gcc"
src = "main.c"
out = "main"
msg = True
say = "Compilation done!"
run = False
mke = False
mkf = "-j$(nproc)"

def getVer():
    print(version)
    exit()

def getHelp():
    print("Usage: fmake [OPTION...] [RULE...]")
    print()
    print("Options:")
    print("rule\tcompiles a specific rule")
    print("example\tgenerates an example make.fmake config")
    print("debug\tprints the value of all possible variables")
    print("project\tmakes a build/ & src/ directory along with a custom make.fmake files")
    print("clean\tremoves any detected compiled executables")
    print("version\tprints fmake version")
    print()
    print("Rules:")
    print("To compile a specific rule a <rule>.fmake file must be present")
    print("along with that, you can compile the rule by running fmake rule <rule>")
    print("If you just want to compile the default make.fmake, just run fmake")

def debug():
    print(f"CC:\t{cc}")
    print(f"SRC\t{src}")
    print(f"OUT\t{out}")
    print(f"MSG\t{msg}")
    print(f"SAY\t{say}")
    print(f"RUN\t{run}")
    print(f"MKE\t{mke}")
    print(f"MKF\t{mkf}")
    exit()

def readConfig(configName):
    global cc
    global src
    global out
    global msg
    global say
    global run
    global mke
    global mkf

    if not os.path.exists(configName + ".fmake"):
        print("[ERROR] Rule has no fmake file")
        exit()
    f = open(configName + ".fmake","r")
    temp = []
    for i in f:
        if not len(i.split()) == 0:
            if not i.split()[0][0] == "#":
                if len(i.split()) >= 3:
                    if i.split()[0] == "cc":
                        cc = i.split()[2]
                    if i.split()[0] == "src":
                        src = i.split()[2]
                    if i.split()[0] == "out":
                        out = i.split()[2]
                    if i.split()[0] == "msg":
                        if i.split()[2] == "true":
                            msg = True
                        if i.split()[2] == "false":
                            msg = False
                    if i.split()[0] == "say":
                        say = " ".join(i.split()[2:])
                    if i.split()[0] == "run":
                        if i.split()[2] == "true":
                            run = True
                        if i.split()[2] == "false":
                            run = False
                    if i.split()[0] == "mke":
                        if i.split()[2] == "true":
                            mke = True
                        if i.split()[2] == "false":
                            mke = False
                    if i.split()[0] == "mkf":
                        while i[0] != "=":
                            i = i[1:]
                        i = i[1:]
                        while i[0] == " ":
                            i = i[1:]
                        mkf = i

def comp():

    if not mke:
        os.system(f"{cc} {src} -o {out}")
    if mke:
        os.system(f"make {mkf}")
    if msg:
        print(say)
    if run and not mke:
        os.system(f"./{out}")
    exit()

def clean():
    if os.path.exists(out):
        print(f"CLEAN\t{out}")
        os.remove(out)
    exit()

def genConfig():
    if os.path.exists("make.fmake"):
        os.remove("make.fmake")
    f = open("make.fmake","w")
    f.write("# Auto generated config\ncc = gcc\nsrc = main.c\nout = main\nmsg = true\nsay $\nrun false\nmke = false\nmkf $\n")
    f.close()
    exit()

def example():
    if os.path.exists("make.fmake"):
        a = input("Overwrite existing make.fmake file? (y/N) ")
        if a.lower() == "y":
            genConfig()
        else:
            exit()
    else:
        genConfig()

def project():
    os.mkdir("build")
    os.mkdir("src")
    f = open("make.fmake","w")
    f.write("src = src/main.c\nout = build/main\n")
    f.close()

if len(sys.argv) == 1 and sys.argv[0] in helps:
    getHelp()
elif len(sys.argv) == 1:
    if sys.argv[0] == "debug":
        readConfig("make")
        debug()
    elif sys.argv[0] in versions:
        getVer()
    elif sys.argv[0] == "clean":
        readConfig("make")
        clean()
    elif sys.argv[0] == "example":
        example()
    elif sys.argv[0] == "project":
        project()
elif len(sys.argv) == 2:
    if sys.argv[0] == "debug":
        readConfig(sys.argv[1])
        debug()
    elif sys.argv[0] == "clean":
        readConfig(sys.argv[1])
        clean()
    elif sys.argv[0] == "rule":
        readConfig(sys.argv[1])
        comp()
elif len(sys.argv) == 0:
    readConfig("make")
    comp()
